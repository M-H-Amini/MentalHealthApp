{% extends "base.html" %}

{% block content %}
<div class="row mt-4" style="background-color: #fcf4dd; padding: 20px; border-radius: 15px;">
    <!-- Left Section -->
    <div class="col-md-4" style="background-color: #fce1e4; padding: 20px; border-radius: 15px;">
        <h3 style="color: #5a5a5a;">About the App</h3>
        <p style="color: #444444;">This app helps you track your mental well-being through sentiment and attention analysis.</p>
        <p style="color: #444444;">Get started by clicking the "Start" button in the middle.</p>
        
        <br>
        <br>
        <!-- Journal Entry Section at the Bottom -->
        <div class="mt-4">
            <h3 style="color: #5a5a5a;">Journal Entry</h3>
            <form id="journal-form">
                <div class="form-group">
                    <textarea class="form-control" name="journal_entry" rows="5" placeholder="Write your thoughts..." required style="border-radius: 15px;"></textarea>
                </div>
                <button type="submit" class="btn btn-secondary" style="background-color: #e4d8f5; color: #5a5a5a; border-radius: 25px;">Add Entry</button>
            </form>
        </div>
    </div>

    <!-- Middle Section -->
    <div class="col-md-4 text-center" style="background-color: #ddedea; padding: 20px; border-radius: 15px;">
        <button id="start-button" class="btn btn-secondary" style="background-color: #cde4f5; color: #5a5a5a; border-radius: 25px;">Start</button>
        <button id="stop-button" class="btn btn-secondary" style="background-color: #cde4f5; color: #5a5a5a; display: none; border-radius: 25px;">Stop</button>

        <!-- Webcam Video -->
        <div id="webcam-container" style="display: none; margin-top: 20px; width: 100%;">
            <video id="video" style="width: 100%; height: auto;" autoplay></video>
        </div>

        <!-- Analysis Display -->
        <div id="analysis-display" style="display: none; margin-top: 20px;">
            <h4 style="color: #5a5a5a;">Current Analysis</h4>
            <p style="color: #444444;"><strong>Sentiment:</strong> <span id="sentiment-result"></span></p>
            <p style="color: #444444;"><strong>Attention:</strong> <span id="attention-result"></span></p>
        </div>
    </div>

    <!-- Right Section -->
    <div class="col-md-4" style="background-color: #fce1e4; padding: 20px; border-radius: 15px;">
        <h3 style="color: #5a5a5a;">Today's Goal</h3>
        <form id="goal-form">
            <div class="form-group">
                <textarea class="form-control" name="goal" rows="2" placeholder="I want to stay focused and mindful throughout my workday..." required style="border-radius: 15px;"></textarea>
            </div>
            <button type="submit" class="btn btn-secondary" style="background-color: #e4d8f5; color: #5a5a5a; border-radius: 25px;">Submit Goal</button>
        </form>

        <br>
        <h3 class="mt-4" style="color: #5a5a5a;">Motivation</h3>
        <blockquote style="color: #444444;">"{{ quote }}"</blockquote>
        <img src="{{ url_for('static', filename='images/' + image) }}" alt="Motivational Image" class="img-fluid" style="border-radius: 15px;">
    </div>
</div>





<!-- JavaScript -->
<script>
    let video = document.getElementById('video');
    let webcamContainer = document.getElementById('webcam-container');
    let startButton = document.getElementById('start-button');
    let stopButton = document.getElementById('stop-button');
    let captureInterval;
    let mediaStream = null;

    function startWebcam() {
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
            .then(function(stream) {
                mediaStream = stream;
                video.srcObject = stream;
                video.play();
                webcamContainer.style.display = 'block';
                startButton.style.display = 'none';
                stopButton.style.display = 'inline-block';
                document.getElementById('analysis-display').style.display = 'block';

                // Start capturing images every 10 seconds
                captureInterval = setInterval(captureImage, 10000);
            })
            .catch(function(err) {
                console.log("An error occurred: " + err);
            });
    }

    function stopWebcam() {
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
        }
        webcamContainer.style.display = 'none';
        startButton.style.display = 'inline-block';
        stopButton.style.display = 'none';
        document.getElementById('analysis-display').style.display = 'none';

        // Stop capturing images
        clearInterval(captureInterval);
    }

    function captureImage() {
        let canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        let context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Get image data URL
        let dataURL = canvas.toDataURL('image/jpeg');

        // Send image data to server via AJAX
        fetch('{{ url_for('capture_image') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ image_data: dataURL })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Image data sent to server:', data);
            // Update the analysis display
            document.getElementById('sentiment-result').textContent = data.sentiment;
            document.getElementById('attention-result').textContent = data.attention;
        })
        .catch(error => {
            console.error('Error sending image data:', error);
        });
    }

    startButton.addEventListener('click', startWebcam);
    stopButton.addEventListener('click', stopWebcam);

    // AJAX for Goal Form
    document.getElementById('goal-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('{{ url_for('set_goal_ajax') }}', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            alert('Goal submitted successfully!');
            this.reset();
        })
        .catch(error => {
            console.error('Error submitting goal:', error);
        });
    });

    // AJAX for Journal Form
    document.getElementById('journal-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('{{ url_for('journal_ajax') }}', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            alert('Journal entry added successfully!');
            this.reset();
        })
        .catch(error => {
            console.error('Error submitting journal entry:', error);
        });
    });
</script>
{% endblock %}
